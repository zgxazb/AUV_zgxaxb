<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
    <!-- 定义样式 -->
    <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
        </marker>
        <style>
            .node {
                fill: white;
                stroke: #333;
                stroke-width: 2;
                rx: 8;
                ry: 8;
            }
            .title {
                fill: white;
                stroke: #444;
                stroke-width: 2;
                rx: 8;
                ry: 8;
            }
            .title-text {
                font-family: Arial, sans-serif;
                font-size: 18px;
                font-weight: bold;
                fill: white;
            }
            .text {
                font-family: Arial, sans-serif;
                font-size: 14px;
                fill: #333;
            }
            .connector {
                stroke: #333;
                stroke-width: 2;
                fill: none;
                marker-end: url(#arrowhead);
            }
            .input-box {
                fill: #e6f7ff;
                stroke: #1890ff;
                stroke-width: 2;
                rx: 8;
                ry: 8;
            }
            .control-box {
                fill: #f6ffed;
                stroke: #52c41a;
                stroke-width: 2;
                rx: 8;
                ry: 8;
            }
            .model-box {
                fill: #fff7e6;
                stroke: #fa8c16;
                stroke-width: 2;
                rx: 8;
                ry: 8;
            }
            .decision-box {
                fill: #fff1f0;
                stroke: #f5222d;
                stroke-width: 2;
            }
            .subsystem-title {
                font-family: Arial, sans-serif;
                font-size: 16px;
                font-weight: bold;
                fill: #333;
            }
        </style>
    </defs>
    
    <!-- 标题 -->
    <rect x="400" y="20" width="400" height="40" class="title" fill="#1890ff"/>
    <text x="600" y="45" text-anchor="middle" class="title-text">AUV运动控制流程图</text>
    
    <!-- 输入部分 -->
    <rect x="100" y="100" width="250" height="200" class="input-box"/>
    <text x="225" y="130" text-anchor="middle" class="subsystem-title">输入处理</text>
    
    <rect x="120" y="160" width="210" height="60" class="node"/>
    <text x="225" y="180" text-anchor="middle" class="text">键盘输入</text>
    <text x="225" y="200" text-anchor="middle" class="text">(W/S/A/D/Q/E等)</text>
    
    <rect x="120" y="240" width="210" height="60" class="node"/>
    <text x="225" y="260" text-anchor="middle" class="text">目标设置</text>
    <text x="225" y="280" text-anchor="middle" class="text">(深度/航向/俯仰/横滚)</text>
    
    <!-- 控制处理部分 -->
    <rect x="400" y="100" width="400" height="500" class="control-box"/>
    <text x="600" y="130" text-anchor="middle" class="subsystem-title">控制逻辑处理</text>
    
    <!-- update方法 -->
    <rect x="450" y="160" width="300" height="40" class="node"/>
    <text x="600" y="185" text-anchor="middle" class="text">update(dt): 更新控制器状态</text>
    
    <!-- 键盘更新 -->
    <rect x="450" y="220" width="300" height="40" class="node"/>
    <text x="600" y="245" text-anchor="middle" class="text">_update_from_keyboard(): 基于键盘输入更新控制指令</text>
    
    <!-- 推力控制 -->
    <rect x="450" y="280" width="300" height="40" class="node"/>
    <text x="600" y="305" text-anchor="middle" class="text">计算推进器推力 (self.thrust)</text>
    
    <!-- 舵角控制决策 -->
    <polygon points="450,340 750,340 730,380 470,380" class="decision-box"/>
    <text x="600" y="365" text-anchor="middle" class="text">独立舵板控制?</text>
    
    <!-- 独立舵板控制 -->
    <rect x="450" y="400" width="300" height="40" class="node"/>
    <text x="600" y="425" text-anchor="middle" class="text">设置各舵板角度 (1-4)</text>
    
    <!-- 组合控制 -->
    <rect x="450" y="460" width="300" height="80" class="node"/>
    <text x="600" y="490" text-anchor="middle" class="text">组合控制</text>
    <text x="600" y="510" text-anchor="middle" class="text">右上舵: pitch+turn, 右下舵: pitch-turn</text>
    <text x="600" y="530" text-anchor="middle" class="text">左上舵: roll, 左下舵: -roll</text>
    
    <!-- PID控制器更新 -->
    <rect x="450" y="560" width="300" height="40" class="node"/>
    <text x="600" y="585" text-anchor="middle" class="text">_update_pid_controllers(dt): 更新PID控制器</text>
    
    <!-- 模型部分 -->
    <rect x="850" y="100" width="250" height="200" class="model-box"/>
    <text x="975" y="130" text-anchor="middle" class="subsystem-title">模型应用</text>
    
    <rect x="870" y="160" width="210" height="60" class="node"/>
    <text x="975" y="180" text-anchor="middle" class="text">应用控制输入</text>
    <text x="975" y="200" text-anchor="middle" class="text">set_control_input(thrust, rudder_angles)</text>
    
    <rect x="870" y="240" width="210" height="60" class="node"/>
    <text x="975" y="260" text-anchor="middle" class="text">更新AUV状态</text>
    <text x="975" y="280" text-anchor="middle" class="text">update_state(dt)</text>
    
    <!-- 状态反馈 -->
    <rect x="850" y="350" width="250" height="150" class="model-box"/>
    <text x="975" y="380" text-anchor="middle" class="subsystem-title">状态反馈</text>
    
    <rect x="870" y="410" width="210" height="60" class="node"/>
    <text x="975" y="430" text-anchor="middle" class="text">获取当前状态</text>
    <text x="975" y="450" text-anchor="middle" class="text">位置/姿态/速度</text>
    
    <!-- 连接线 -->
    <!-- 输入到控制 -->
    <line x1="350" y1="190" x2="450" y2="180" class="connector"/>
    <line x1="350" y1="270" x2="450" y2="580" class="connector"/>
    
    <!-- 控制内部连接 -->
    <line x1="600" y1="200" x2="600" y2="220" class="connector"/>
    <line x1="600" y1="260" x2="600" y2="280" class="connector"/>
    <line x1="600" y1="320" x2="600" y2="340" class="connector"/>
    
    <!-- 决策分支 -->
    <line x1="750" y1="360" x2="850" y2="360" class="connector"/>
    <line x1="850" y1="360" x2="850" y2="400" class="connector"/>
    <line x1="600" y1="380" x2="600" y2="400" class="connector"/>
    <line x1="600" y1="440" x2="600" y2="460" class="connector"/>
    <line x1="600" y1="540" x2="600" y2="560" class="connector"/>
    
    <!-- 控制到模型 -->
    <line x1="750" y1="180" x2="850" y2="180" class="connector"/>
    <line x1="750" y1="580" x2="850" y2="180" class="connector"/>
    
    <!-- 模型内部连接 -->
    <line x1="975" y1="220" x2="975" y2="240" class="connector"/>
    
    <!-- 反馈连接 -->
    <path d="M 975 470 C 975 500, 400 500, 400 340" class="connector"/>
    
    <!-- 说明文本 -->
    <rect x="100" y="350" width="1000" height="100" class="node" fill="#f5f5f5"/>
    <text x="600" y="380" text-anchor="middle" class="text">说明：</text>
    <text x="600" y="400" text-anchor="middle" class="text">1. 控制优先级：独立舵板控制 > 组合控制 > PID控制</text>
    <text x="600" y="420" text-anchor="middle" class="text">2. 系统采用12维状态向量描述AUV状态：[x,y,z,phi,theta,psi,u,v,w,p,q,r]</text>
    
    <!-- PID控制器细节 -->
    <rect x="100" y="500" width="400" height="200" class="control-box"/>
    <text x="300" y="530" text-anchor="middle" class="subsystem-title">PID控制器实现</text>
    
    <rect x="120" y="560" width="360" height="120" class="node"/>
    <text x="300" y="580" text-anchor="middle" class="text">四个独立PID控制器:</text>
    <text x="300" y="600" text-anchor="middle" class="text">• 深度控制: kp=10.0, ki=0.1, kd=2.0</text>
    <text x="300" y="620" text-anchor="middle" class="text">• 航向控制: kp=5.0, ki=0.05, kd=1.0</text>
    <text x="300" y="640" text-anchor="middle" class="text">• 俯仰控制: kp=8.0, ki=0.1, kd=1.5</text>
    <text x="300" y="660" text-anchor="middle" class="text">• 横滚控制: kp=6.0, ki=0.05, kd=1.0</text>
</svg>